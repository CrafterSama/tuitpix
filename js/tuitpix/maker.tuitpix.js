/*
 * maker.tuitpix.js
 * Copyright (c) 2011 Daniel Rodriguez, dan@tuitpix.com
 * MIT License [http://www.opensource.org/licenses/mit-license.php]
 */
var tuitpix={canv:null,cont:null,contm:false,mdown:false,mouse:{x:0,y:0},active:"gen",matrix:[],can:function(c){var a=this;for(var b=0;b<=1849;b++)a.matrix.push(0);a.canv=document.getElementById(c);a.cont=a.canv.getContext("2d")},setNext:function(){},setPrev:function(){}};tuitpix.clear=function(){var a=this;a.cont.clearRect(0,0,a.canv.width,a.canv.height);a.matrix=Array();for(var b=0;b<=1849;b++)a.matrix.push(0)};tuitpix.tool=0;tuitpix.draw=function(c,e){var o="#loading",b=this;if(!c)return;$(o).css("display")!=="none"&&$(o).fadeOut(140);if(c=="json"&&e)for(j in e)tuitpix.draw(e[j],1);else for(m in c[1]){var g=7,i=7;if(c[1][m].length){var a=c[1][m];if(!e&&b.looking){var l=a[0]/43,l=parseInt(l.toString().split(".")[0]);a[0]=43*(l+1)-(a[0]-43*l)-1}g=a[1]*7;var p=!e&&b.looking?-1:1;if(a[2])i=a[2]*7;for(var h=0;h<a[1];h++){tuitpix.matrix[a[0]+h*p]=b.tool?undefined:c[0];for(var n=1;n<a[2];n++)tuitpix.matrix[a[0]+h*p+43*n]=b.tool?undefined:c[0]}a=a[0]}else a=c[1][m];var f=a/43,k=Math.round(f),d=a-43*k;d=(d<0?43+d:d)*7;f=(k-(f<k?1:0))*7;if(b.looking){d=b.canv.width-d;g*=-1}if(!b.tool){b.cont.fillStyle=c[0]||"#FF0000";b.cont.fillRect(d,f,g,i)}else b.cont.clearRect(d,f,g,i)}};tuitpix.setTool=function(a){var d=".color_maker",c="inuse",b="class",a=$(a);if(a.attr(b)===c)return;var e=document.getElementsByClassName(c);$(e[0]).attr(b,"");var f=a.attr("id");if(f==="img_brsh"){this.tool=0;$(d).fadeIn(140)}else{this.tool=1;$(d).fadeOut(140)}a.attr(b,c)};tuitpix.drawJSON=function(){this.clear();tuitpix.draw("json",$.parseJSON(prompt("( >°□°)> < Gimme your JSONs!")))};tuitpix.setActive=function(b){var d="s/load.php",c="#loading",a="json";if(!tuitpix.USER){$.ajax({url:"js/on/maker.json",dataType:a,success:function(b){tuitpix.draw(a,b)}});return}var b=$(b);$(c).css("display")!=="none"&&setTimeout("tuitpix.setActive("+b+")",140);$("#left_menu .active").attr("class","");var e=b.attr("id").split("_")[1];this.active=e;tuitpix.setTool("#img_brsh");b.attr("class","active");this.clear();$(c).fadeIn(140);tuitpix.loading();if(LOAD!==null)LOAD=null;$.ajax({type:"POST",url:d,data:"active="+this.active,success:function(b){var b=b?$.parseJSON(b)[0]:{};if(b[tuitpix.active]){if(b.sex!==undefined){tuitpix.gender=!parseInt(b.sex);tuitpix.setGender()}if(b.looking!==undefined){tuitpix.looking=parseInt(b.looking);b.looking=="1"&&$("#maker").css("background-image","url(img/makerbg_left.png)")}var c=tuitpix.decodeFromHex(b[tuitpix.active]);if(c.length<7)c="{[]}";tuitpix.draw(a,jsonParse(c))}else $.ajax({type:"POST",url:d,data:"active="+tuitpix.active+"&of=index",success:function(c){var c=$.parseJSON(c)[0],b=tuitpix.decodeFromHex(c[tuitpix.active]);if(b.length<7)b="{[]}";tuitpix.draw(a,jsonParse(b))}})}})};tuitpix.gender=0;tuitpix.setGender=function(){if(this.gender){$("#maker").css({backgroundPosition:"0px 0px"});$("#img_girl").attr({id:"img_boy"});this.gender=0}else{$("#maker").css({backgroundPosition:"-301px 0px"});$("#img_boy").attr({id:"img_girl"});this.gender=1}};tuitpix.color=null;tuitpix.changeColor=function(a){this.color=a};tuitpix.RGBtoHex=function(c,b,a){return this.toHex(c)+this.toHex(b)+this.toHex(a)};tuitpix.toHex=function(a){var b="0123456789ABCDEF";if(a===null)return"00";a=parseInt(a);if(a===0||isNaN(a))return"00";a=Math.max(0,a);a=Math.min(a,255);a=Math.round(a);return b.charAt((a-a%16)/16)+b.charAt(a%16)};tuitpix.resetPalette=function(){var a="#0A0A0A";tuitpix.color=a;$("#colors").attr("value",a).css({background:a,marginLeft:"0px",marginTop:"0px"})};tuitpix.GO=function(g){var c=this;if(!tuitpix.USER&&!g)return;var b={};for(m in c.matrix)if(c.matrix[m]){if(!b[c.matrix[m]])b[c.matrix[m]]=[];var h=b[c.matrix[m]];(function(a){if(!a)a=h;if(!isNaN(a[0]))for(f in a)arguments.callee(a[f]);else{var c=a?Math.abs(a[0]+a[1]-1-m):-1,d=a?Math.abs(a[0]-m)-43*a[2]:-1;if(c==1&&a[2]==1)b[tuitpix.matrix[m]][b[tuitpix.matrix[m]].length-1][1]+=1;else if(d==0&&a[1]==1)b[tuitpix.matrix[m]][b[tuitpix.matrix[m]].length-1][2]+=1;else b[tuitpix.matrix[m]].push([parseInt(m),1,1])}})()}var d=function(a){var e=0;while(e<2){for(var b=0;b<a.length;b++)for(var c=0;c<a.length;c++){if(c===b)continue;if(e==0){var g=a[b][0]+43*a[b][2]-a[c][0],h=a[b][1]===a[c][1];if(g===0&&h){a[b][2]+=1;a.splice(c,1);return d(a)}}else{if(a[b][1]==1&&!((a[b][0]+1)%43))continue;var f=a[b][0]+a[b][1]-a[c][0]==0,i=a[b][2]===a[c][2];if(f&&i){a[b][1]+=1;a.splice(c,1);return d(a)}}}e++}return a};for(f in b)b[f]=d(b[f]);var a="[";for(f in b){a+=' [ "'+f.toUpperCase()+'", [';for(ff in b[f]){a+=" [";for(fff in b[f][ff])a+=b[f][ff][fff]+",";a=a.substring(0,a.length-1);a+="],"}a=a.substring(0,a.length-1);a+=" ] ],\n "}a=a.substring(0,a.length-3);a+="\n]";if(g)return alert(a);var e="";e+=c.active+"="+c.encodeToHex(a);$.ajax({type:"POST",url:"s/save.php",data:e,success:function(a){if(!a)return;tuitpix.help("save")}})};tuitpix.mouse=function(f){var e=".color_maker",d="#maker",c=this,a=tuitpix.mouse;if(!tuitpix.mouse.offset)tuitpix.mouse.offset=$(d).offset();if(!a.width){tuitpix.mouse.width=$(d).css("width");tuitpix.mouse.width=parseInt(tuitpix.mouse.width.slice(0,tuitpix.mouse.width.length-2))+tuitpix.mouse.offset.left+7}if(!a.height){tuitpix.mouse.height=$(d).css("height");tuitpix.mouse.height=parseInt(tuitpix.mouse.height.slice(0,tuitpix.mouse.height.length-2))+tuitpix.mouse.offset.top+4}a=tuitpix.mouse;var i=a.x>a.width||a.x<a.offset.left||a.y>a.height||a.y<tuitpix.mouse.offset.top;if(i||!a.x||!a.y)return;tuitpix.color_maker_big&&$(e).animate({width:"28px"},140,function(){$(e).css({fontSize:"0px"});tuitpix.color_maker_big=0});a.x-=a.offset.left;a.y-=a.offset.top;if(f===0&&!c.contm){if(!c.color)c.color=$("#colors").attr("value");var g=[c.color,[]],h=parseInt(((a.x-7)/7).toString().split(".")[0]);h+=43*(parseInt((a.y/7).toString().split(".")[0])-1);g[1].push([h,1,1]);c.draw(g)}else if(f===2){var b=tuitpix.cont.getImageData(a.x-7,a.y-7,1,1).data;b=tuitpix.RGBtoHex(b[0],b[1],b[2]);document.getElementById("colors").color.fromString("#"+b);tuitpix.color="#"+b;$("#colors").attr("value","#"+b);return false}};window.onload=function(){tuitpix.can("maker");$("#maker").css("background-image","url(img/makerbg.png)");tuitpix.setActive("#img_gen");$(".color_maker").click(function(){$(this).animate({width:"63px"},140,function(){$(this).css({fontSize:"14px",position:"relative"});tuitpix.color_maker_big=1})});document.onmousemove=function(a){var b=document.all&&event.clientX?event.clientX+(document.documentElement.scrollLeft||document.body.scrollLeft):a.pageX?a.pageX:null,c=document.all&&event.clientY?event.clientY+(document.documentElement.scrollTop||document.body.scrollTop):a.pageY?a.pageY:null;tuitpix.mouse.x=b;tuitpix.mouse.y=c;tuitpix.mdown&&tuitpix.mouse(0)};document.onclick=function(a){if(a.button!==0)return;tuitpix.mouse(a.button)};document.onmousedown=function(){tuitpix.mdown=true};document.onmouseup=function(){tuitpix.mdown=false};document.oncontextmenu=function(a){tuitpix.mouse(a.button);return false};document.onkeypress=function(a){if(a.charCode==98)tuitpix.setTool("#img_brsh");else a.charCode==101&&tuitpix.setTool("#img_ersr")}};