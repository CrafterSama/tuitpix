/*
 * tuitpix.js
 * Copyright (c) 2011 Daniel Rodriguez, dan@tuitpix.com
 * MIT License [http://www.opensource.org/licenses/mit-license.php]
 */
var tuitpix={canv:null,cont:null,contm:false,_skin:0,skins:[["#DAC49E","#AF9D7E","#9E8860"],["#AD8B62","#806748","#231e1b"],["#CDA57B","#B8946E","#3E2115"],["#EEC9A2","#C9A988","#B87A38"],["#3C332B","#302C28","#212121"]],peep:{gen:[],wear:[],hair:[],beard:[],addon:[]},mouse:{x:0,y:0},can:function(a){this.canv=document.getElementById(a);this.cont=this.canv.getContext("2d")},active:"gen",conf:{gen:0,hair:0,beard:0,wear:0,addon:0},cats:{hair:0,beard:0,wear:0,addon:0},"set":null,Set:function(f,c){var e="controls",d="#loading",a=this;if(f)a.set=f;for(i in a.peep){if(!a.set||!a.set[i])continue;if(i==="gen")a.peep[i]=a.set[i][a.conf[i]][0];else if(a.set[i][a.cats[i]].length<=1){$(d).fadeIn();a.loading();return $.getJSON("js/on/"+i+"_"+a.set[i][a.cats[i]][0]+".json",function(a){$(d).fadeOut();tuitpix._help.current="";tuitpix.help(e);tuitpix.set[i][tuitpix.cats[i]][1]=a;return tuitpix.Set(0,c)})}else{a._help.current="";a.help(e);var b=a.set[i][a.cats[i]][1][a.conf.gen];a.peep[i]=b[a.conf[i]]?b[a.conf[i]]:b[b.length-1]}}a.redraw();if(c)return tuitpix.LOAD(c)},setNext:function(){var a=this,c=$("#loading");if(!a.set[a.active]||c&&c.css("display")!=="none")return;var d=a.active==="gen"?a.set[a.active]:a.set[a.active][a.cats[a.active]][1][a.conf.gen],b=a.conf[a.active];if(!d)return;a.conf[a.active]=d[b+1]?b+1:0;a.Set();a.resetPalette()},setPrev:function(){var a=this,d=$("#loading");if(!a.set[a.active]||d&&d.css("display")!=="none")return;var b=a.active==="gen"?a.set[a.active]:a.set[a.active][a.cats[a.active]][1][a.conf.gen],c=a.conf[a.active];if(!b)return;a.conf[a.active]=b[c-1]?c-1:b.length-1;a.Set();a.resetPalette()},setCat:function(b){var a=this,c=$("#loading");if(c&&c.css("display")!=="none")return;if(b>0)a.cats[a.active]=a.cats[a.active]+b==a.set[a.active].length?0:a.cats[a.active]+b;if(b<0)a.cats[a.active]=a.cats[a.active]==0?a.set[a.active].length-1:a.cats[a.active]+b;a.Set()},looking:null,look:function(a){this.looking=a;this.resetPalette();this.redraw()},setSkin:function(b){var a=this;if(b>0)a._skin=a._skin+b==a.skins.length?0:a._skin+b;if(b<0)a._skin=a._skin==0?a.skins.length-1:a._skin+b;for(i in a.skins[0]){a.active=i<2?"gen":"hair";a.color=i<2?a.set.gen[a.conf.gen][0][i][0]:a.set.hair[a.cats.hair][1][a.conf.gen][0][0][0];a.changeColor(a.skins[a._skin][i])}a.active="gen";a.resetPalette()}};tuitpix.redraw=function(){this.clear();this.draw()};tuitpix.clear=function(){this.cont.clearRect(0,0,this.canv.width,this.canv.height)};tuitpix.draw=function(a){var b=this;if(!a)for(p in b.peep)b.draw(b.peep[p]);else if(typeof a[0]!=="string")for(m in a)b.draw(a[m]);else for(m in a[1]){var e=7,g=7;if(a[1][m].length){Mm=a[1][m];e=Mm[1]*7;if(Mm[2])g=Mm[2]*7;Mm=Mm[0]}else Mm=a[1][m];var d=Mm/43,f=Math.round(d),c=Mm-43*f;c=(c<0?43+c:c)*7;d=(f-(d<f?1:0))*7;if(b.looking){c=b.canv.width-c;e*=-1}b.cont.fillStyle=a[0]||"#FF0000";b.cont.fillRect(c,d,e,g)}};tuitpix.color=null;tuitpix.changeColor=function(d,g){var a=this;if(!d||!a.color)return;var d=d.toUpperCase(),c=a.set,b=a.active,e=a.cats[b],f=a.conf[b];if(b=="gen"){for(s in c[b])for(ss in c[b][s][0])if(c[b][s][0][ss][0]===a.color)a.set[b][s][0][ss][0]=d}else for(s in c[b][e][1])for(ss in c[b][e][1][s][f])if(c[b][e][1][s][f][ss][0]===a.color)a.set[b][e][1][s][f][ss][0]=d;if(g)return;a.Set();a.draw();a.color=d};tuitpix.RGBtoHex=function(c,b,a){return this.toHex(c)+this.toHex(b)+this.toHex(a)};tuitpix.toHex=function(a){var b="0123456789ABCDEF";if(a===null)return"00";a=parseInt(a);if(a===0||isNaN(a))return"00";a=Math.max(0,a);a=Math.min(a,255);a=Math.round(a);return b.charAt((a-a%16)/16)+b.charAt(a%16)};tuitpix.resetPalette=function(){var a="#0A0A0A";this.color=a;$("#colors").attr("value",a).css({background:a,marginLeft:"0px",marginTop:"0px"})};tuitpix.setControls=function(c){var g="#controls #sub #arrow_right",b="onClick",f="#controls #sub #arrow_left",e="#controls #subsub",d="class",c=$(c);if(c.attr(d)==="active")return;$("#left_menu .active").attr(d,"");var a=c.attr("id"),h=$("#"+a).offset();$("#controls #main, #controls #sub").css({marginTop:h.top-63});if(a==="img_gen"){$(e).fadeIn(140);$(f).attr(b,"tuitpix.look(true)");$(g).attr(b,"tuitpix.look(false)")}else{$(e).fadeOut(0);$(f).attr(b,"tuitpix.setCat(-1)");$(g).attr(b,"tuitpix.setCat(1)")}a=a.split("_")[1];this.active=a;c.attr(d,"active")};tuitpix.READY=function(){window.open(this.canv.toDataURL("image/png"))};window.onload=function(){tuitpix.can("avatar");$.ajax({url:"js/on/_tuitpix.json",dataType:"json",success:function(a){$("#loading").fadeOut();tuitpix.Set(a||"[]",LOAD);return}});document.onmousemove=function(a){var b=document.all&&event.clientX?event.clientX+(document.documentElement.scrollLeft||document.body.scrollLeft):a.pageX?a.pageX:null,c=document.all&&event.clientY?event.clientY+(document.documentElement.scrollTop||document.body.scrollTop):a.pageY?a.pageY:null;tuitpix.mouse.x=b;tuitpix.mouse.y=c};document.oncontextmenu=function(h){var e="#avatar";if(h.button!==2)return;var a=tuitpix.mouse,c=$(e).offset(),f=$(e).css("width"),f=parseInt(f.slice(0,f.length-2))+c.left,d=$(e).css("height");d=parseInt(d.slice(0,d.length-2))+c.top;var g=a.x>f||a.x<c.left||a.y>d||a.y<c.top;if(g)return;a.x-=c.left;a.y-=c.top;var b=tuitpix.cont.getImageData(a.x-7,a.y-7,1,1).data;b=tuitpix.RGBtoHex(b[0],b[1],b[2]);document.getElementById("colors").color.fromString(b);tuitpix.color="#"+b;$("#colors").attr("value",b).css({marginLeft:a.x,marginTop:a.y}).focus();return false}};